name: Run test suite
on: [push, pull_request]

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
        # non-testing jobs
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: security
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: flake8
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: pylint
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: typing
        - os: ubuntu-18.04
          python-version: 3.7  # Keep in sync with .readthedocs.yml
          env:
            TOXENV: docs

        # tests
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: py
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: py

        # windows tests
        - os: windows-latest
          python-version: 3.7
          env:
            TOXENV: py
        - os: windows-latest
          python-version: 3.8
          env:
            TOXENV: py

        # pinned deps
        - os: ubuntu-18.04
          python-version: 3.6.1
          env:
            TOXENV: pinned
        - os: ubuntu-18.04
          python-version: 3.6.1
          env:
            TOXENV: asyncio-pinned
        # - os: windows-latest
        #   python-version: 3.6
        #   env:
        #     TOXENV: windows-pinned

        # extras
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: extra-deps
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: asyncio

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

    - name: Run test suite
      env: ${{ matrix.env }}
      run: |
        pip install -U tox twine wheel codecov
        tox
