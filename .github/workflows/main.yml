name: Build
on: [push, pull_request]

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
        # non-testing jobs
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: security
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: flake8
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: pylint
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: typing
        - os: ubuntu-18.04
          python-version: 3.7  # Keep in sync with .readthedocs.yml
          env:
            TOXENV: docs

        # tests
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: py
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: py
        - os: ubuntu-18.04
          python-version: pypy3
          env:
            TOXENV: pypy3

        # windows tests
        - os: windows-latest
          python-version: 3.7
          env:
            TOXENV: py
        - os: windows-latest
          python-version: 3.8
          env:
            TOXENV: py

        # pinned deps
        # - os: ubuntu-18.04
        #   python-version: 3.6.12
        #   env:
        #     TOXENV: pinned
        # - os: ubuntu-18.04
        #   python-version: 3.6.12
        #   env:
        #     TOXENV: asyncio-pinned
        # - os: windows-latest
        #   python-version: 3.6
        #   env:
        #     TOXENV: windows-pinned

        # extras
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: extra-deps
        - os: ubuntu-18.04
          python-version: 3.8
          env:
            TOXENV: asyncio

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install libraries
      if: ${{ env.TOXENV == 'pypy3' }}
      run: apt-get update && apt-get install libxml2-dev libxslt-dev

    - name: Run check
      env: ${{ matrix.env }}
      run: |
        pip install -U tox
        tox
